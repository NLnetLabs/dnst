[package]
name = "dnst"
version = "0.1.0"
edition = "2021"
default-run = "dnst"
readme = "README.md"
repository = "https://github.com/nlnetlabs/dnst/"
authors = ["NLnet Labs <dns-team@nlnetlabs.nl>"]
description = "Rust reimplementation of important ldns programs."
categories = ["command-line-utilities"]
license = "BSD-3-Clause"
keywords = ["DNS", "domain", "ldns"]
rust-version = "1.79"

[[bin]]
name = "ldns"
path = "src/bin/ldns.rs"

[features]
default = ["openssl", "ring"]

# Cryptographic backends
openssl = ["domain/openssl"]
ring = ["domain/ring"]

# For building in a cargo cross container that lacks openssl-dev so cannot
# successfully compile the Rust OpenSSL crate.
static-openssl = ["domain/static-openssl"]

[dependencies]
bytes = "1.8.0"
chrono = "0.4.38"
clap = { version = "4.3.4", features = ["cargo", "derive"] }
domain = { git = "https://github.com/NLnetLabs/domain.git", branch = "add-static-openssl-feature", features = [
    "bytes",
    "net",
    "resolv",
    "tsig",
    "unstable-client-transport",
    "unstable-sign",
    "unstable-validator",
    "zonefile",
] }
lexopt = "0.3.0"
tokio = "1.40.0"

# This is a workaround. lazy_static 1.0.0 fails to compile, but sharded-slab
# still uses it. And sharded-slab is used by tracing-subscriber, which is
# used by domain, which is used by us.
_unused_lazy_static = { package = "lazy_static", version = "1.0.2" }

[dev-dependencies]
test_bin = "0.4.0"
tempfile = "3.14.0"
regex = "1.11.1"
domain = { git = "https://github.com/NLnetLabs/domain.git", branch = "add-static-openssl-feature", features = [
    "unstable-stelline",
] }

[package.metadata.deb]
license-file = ["LICENSE", "0"]
depends = "$auto"
section = "net"
priority = "optional"
assets = [
    ["target/release/dnst", "usr/bin/", "755"],
    ["README.md", "usr/share/doc/dnst/", "644"],
    # TODO: Extend Ploutos to generate the man pages from sources.
    #["doc/dnst.1", "usr/share/man/man1/dnst.1", "644"],
]
changelog = "target/debian/changelog" # this will be generated by the pkg workflow
copyright = "Copyright (c) 2024, NLnet Labs. All rights reserved."
# preserve_symlinks didn't prevent error "Asset file path does not match any files"
# Perhaps a newer version of cargo-deb than the one used by Ploutos would fix this.
# Instead create and remove them using maintainer scripts.
#preserve-symlinks = true
maintainer-scripts = "pkg/debian"
conflicts = "ldnsutils"

[package.metadata.generate-rpm]
# "BSD" alone is the 3-clause license. Inheriting "license" from above causes rpmlint to
# complain with "invalid-license".
# See: https://fedoraproject.org/wiki/Licensing:Main?rd=Licensing
license = "BSD"
assets = [
    { source = "target/release/dnst", dest = "/usr/bin/dnst", mode = "755" },
    # TODO: Extend Ploutos to generate the man pages from sources.
    #{ source = "doc/routinator.1", dest = "/usr/share/man/man1/routinator.1", mode = "644", doc = true },
]
# Set Provides and Obsoletes per https://docs.fedoraproject.org/en-US/packaging-guidelines/#renaming-or-replacing-existing-packages.
obsoletes = "ldns < 0:1.8.4-2"

# These get set using cargo-generate-rpm --set-metadata at package build time.
#post_install_script = ...
#pre_uninstall_script = ...
#post_uninstall_script = ...

[package.metadata.generate-rpm.conflicts]
ldns-utils = "*"
